#!/bin/bash

# Ø³ÙƒØ±ÙŠØ¨Øª Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ (UFW)

echo "=========================================="
echo "  Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ - MedMap"
echo "=========================================="
echo ""

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø°Ø±
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø°Ø± (sudo)"
    exit 1
fi

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ«Ø¨ÙŠØª UFW
if ! command -v ufw &> /dev/null; then
    echo "ðŸ“¦ ØªØ«Ø¨ÙŠØª UFW..."
    apt-get update
    apt-get install -y ufw
fi

echo "âš™ï¸  Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ..."
echo ""

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
echo "1ï¸âƒ£  Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©..."
ufw default deny incoming
ufw default allow outgoing

# Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ SSH (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!)
echo "2ï¸âƒ£  Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ SSH (Ø§Ù„Ù…Ù†ÙØ° 22)..."
ufw allow 22/tcp
echo "   âœ… ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ SSH"

# Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTP
echo "3ï¸âƒ£  Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTP (Ø§Ù„Ù…Ù†ÙØ° 80)..."
ufw allow 80/tcp
echo "   âœ… ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTP"

# Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTPS
echo "4ï¸âƒ£  Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTPS (Ø§Ù„Ù…Ù†ÙØ° 443)..."
ufw allow 443/tcp
echo "   âœ… ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTPS"

# Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ PostgreSQL
echo ""
read -p "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù„Ù€ PostgreSQLØŸ (y/n): " allow_postgres
if [ "$allow_postgres" = "y" ]; then
    echo "5ï¸âƒ£  Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ PostgreSQL (Ø§Ù„Ù…Ù†ÙØ° 5432)..."
    ufw allow 5432/tcp
    echo "   âš ï¸  ØªØ­Ø°ÙŠØ±: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ£Ù…ÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!"
else
    echo "5ï¸âƒ£  PostgreSQL Ù…Ø­Ù…ÙŠ (Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙ‚Ø·)"
fi

# Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ API
echo ""
read -p "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ API (Ø§Ù„Ù…Ù†ÙØ° 5000)ØŸ (y/n): " allow_api
if [ "$allow_api" = "y" ]; then
    echo "6ï¸âƒ£  Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ API (Ø§Ù„Ù…Ù†ÙØ° 5000)..."
    ufw allow 5000/tcp
    echo "   â„¹ï¸  ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ API Ù…Ø¨Ø§Ø´Ø±Ø©"
else
    echo "6ï¸âƒ£  API Ù…Ø­Ù…ÙŠ (Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ø¨Ø± Nginx ÙÙ‚Ø·)"
fi

# ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
echo ""
echo "7ï¸âƒ£  ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ..."
echo "y" | ufw enable

# Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
echo ""
echo "=========================================="
echo "âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­!"
echo "=========================================="
echo ""
echo "ðŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ:"
ufw status verbose

echo ""
echo "ðŸ“ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø©:"
ufw status numbered

echo ""
echo "âš ï¸  Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:"
echo "   - ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† SSH (22) Ù…ÙØªÙˆØ­ Ù„ØªØ¬Ù†Ø¨ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„"
echo "   - ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: ufw allow/deny PORT"
echo "   - Ù„Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø©: ufw delete RULE_NUMBER"
echo "   - Ù„ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ: ufw disable"
echo ""

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø±Ø¬Ø¹ÙŠ
cat > firewall-rules.txt << EOF
# Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ - MedMap
# ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠ: $(date)

## Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø©:
$(ufw status numbered)

## Ø£ÙˆØ§Ù…Ø± Ù…ÙÙŠØ¯Ø©:
# Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
sudo ufw status verbose

# Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ù†ÙØ°
sudo ufw allow PORT/tcp

# Ù…Ù†Ø¹ Ù…Ù†ÙØ°
sudo ufw deny PORT/tcp

# Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø©
sudo ufw delete RULE_NUMBER

# Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
sudo ufw reload

# ØªØ¹Ø·ÙŠÙ„
sudo ufw disable

# ØªÙØ¹ÙŠÙ„
sudo ufw enable
EOF

echo "ðŸ“„ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙÙŠ: firewall-rules.txt"
echo ""

