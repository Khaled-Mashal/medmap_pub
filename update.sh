#!/bin/bash

# ุณูุฑูุจุช ุชุญุฏูุซ ุงูุชุทุจูู

echo "=========================================="
echo "  ุชุญุฏูุซ MedMap"
echo "=========================================="
echo ""

# ุงูุชุญูู ูู ูุฌูุฏ ูููุงุช ุฌุฏูุฏุฉ
if [ ! -d "publish" ]; then
    echo "โ ุฎุทุฃ: ูุฌูุฏ publish ุบูุฑ ููุฌูุฏ"
    exit 1
fi

# ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุชุญุฏูุซ
echo "๐พ ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุชุญุฏูุซ..."
./backup.sh

if [ $? -ne 0 ]; then
    echo "โ ูุดู ุงููุณุฎ ุงูุงุญุชูุงุทู"
    read -p "ูู ุชุฑูุฏ ุงููุชุงุจุนุฉ ุจุฏูู ูุณุฎุฉ ุงุญุชูุงุทูุฉุ (y/n): " continue
    if [ "$continue" != "y" ]; then
        exit 1
    fi
fi

# ุฅููุงู ุฎุฏูุฉ API
echo "๐ ุฅููุงู ุฎุฏูุฉ API..."
docker-compose stop api

# ุฅุนุงุฏุฉ ุจูุงุก ุตูุฑุฉ API
echo "๐จ ุจูุงุก ุตูุฑุฉ API ุงูุฌุฏูุฏุฉ..."
docker-compose build api

if [ $? -ne 0 ]; then
    echo "โ ูุดู ุจูุงุก ุงูุตูุฑุฉ"
    echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู ุงููุณุฎุฉ ุงููุฏููุฉ..."
    docker-compose start api
    exit 1
fi

# ุชุดุบูู ุงููุณุฎุฉ ุงูุฌุฏูุฏุฉ
echo "๐ ุชุดุบูู ุงููุณุฎุฉ ุงูุฌุฏูุฏุฉ..."
docker-compose up -d api

# ุงูุงูุชุธุงุฑ ููููุงู
echo "โณ ุงูุชุธุงุฑ ุจุฏุก ุงูุฎุฏูุฉ..."
sleep 10

# ุงูุชุญูู ูู ุตุญุฉ ุงูุชุดุบูู
echo "๐ ุงูุชุญูู ูู ุตุญุฉ ุงูุชุดุบูู..."
if curl -f -s http://localhost:5000 > /dev/null; then
    echo "โ ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ!"
    
    # ุชูุธูู ุงูุตูุฑ ุงููุฏููุฉ
    echo "๐งน ุชูุธูู ุงูุตูุฑ ุงููุฏููุฉ..."
    docker image prune -f
    
    echo ""
    echo "=========================================="
    echo "โ ุงูุชูู ุงูุชุญุฏูุซ ุจูุฌุงุญ!"
    echo "=========================================="
    echo ""
    echo "๐ ุญุงูุฉ ุงูุฎุฏูุงุช:"
    docker-compose ps
else
    echo "โ ูุดู ุงูุชุญุฏูุซ - ุงูุฎุฏูุฉ ูุง ุชุณุชุฌูุจ"
    echo "๐ ูุญุงููุฉ ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงููุฏููุฉ..."
    
    # ูุญุงููุฉ ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงููุฏููุฉ
    docker-compose down api
    docker-compose up -d api
    
    echo "โ๏ธ  ูุฑุฌู ุงูุชุญูู ูู ุงูุณุฌูุงุช: ./logs.sh"
    exit 1
fi

echo ""
echo "๐ ููุงุญุธุงุช:"
echo "   - ุชู ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุฌูุฏ backups/"
echo "   - ุฑุงูุจ ุงูุณุฌูุงุช ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก: ./logs.sh"
echo "   - ูู ุจูุญุต ุตุญุฉ ุงููุธุงู: ./health-check.sh"
echo ""

