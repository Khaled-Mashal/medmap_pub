# ุงุณุชุฎุฏุงู ุตูุฑุฉ ASP.NET Core Runtime
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base

# ุชุซุจูุช dependencies ูุทููุจุฉ ูู Skia ู DevExpress
RUN apt-get update && apt-get install -y \
    # Native libraries ุฃุณุงุณูุฉ ูู Skia
    libfontconfig1 \
    libfontconfig1-dev \
    libfreetype6 \
    libfreetype6-dev \
    # ููุชุจุงุช ุฃุณุงุณูุฉ
    libc6 \
    libicu-dev \
    libgdiplus \
    libc6-dev \
    fontconfig \
    software-properties-common \
    # ุฃุฏูุงุช ูุณุงุนุฏุฉ
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ุชุซุจูุช ุงูุฎุทูุท ุงูุฃุณุงุณูุฉ
RUN apt-get update && apt-get install -y \
    # ุฎุทูุท Liberation (ุจุฏูู Arial, Times, Courier)
    fonts-liberation \
    fonts-liberation2 \
    # ุฎุทูุท DejaVu (ุจุฏูู Verdana, Tahoma)
    fonts-dejavu \
    fonts-dejavu-core \
    fonts-dejavu-extra \
    # ุฎุทูุท Noto (ุฏุนู Unicode ุดุงูู)
    fonts-noto \
    fonts-noto-core \
    fonts-noto-ui-core \
    fonts-noto-color-emoji \
    # ุฎุทูุท ุนุฑุจูุฉ
    fonts-arabeyes \
    fonts-kacst \
    fonts-kacst-one \
    fonts-farsiweb \
    # ุฎุทูุท ุฅุถุงููุฉ
    fonts-freefont-ttf \
    fonts-opensymbol \
    && rm -rf /var/lib/apt/lists/*

# (ุงุฎุชูุงุฑู) ุชุซุจูุช ุฎุทูุท Microsoft Core Fonts
# ูููุตุญ ุจู ูุชูุงูู ุฃูุถู ูุน DevExpress
RUN echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections && \
    echo "deb http://deb.debian.org/debian bookworm contrib" >> /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y ttf-mscorefonts-installer && \
    rm -rf /var/lib/apt/lists/*

# ุชุญุฏูุซ ุฐุงูุฑุฉ ุงูุฎุทูุท
RUN fc-cache -fv

WORKDIR /app
EXPOSE 80
EXPOSE 443

# ุชุนููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูู fontconfig ู Skia
ENV FONTCONFIG_PATH=/etc/fonts:/usr/share/fontconfig:/app/Fonts
ENV SKIA_FONT_CACHE_LIMIT=8
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false

# ูุณุฎ ุฌููุน ุงููููุงุช ุงูููุดูุฑุฉ (ูุดูู ูุฌูุฏ Fonts)
COPY . .

# ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุฌูุฏ Fonts ูุตูุงุญูุงุชู
RUN if [ -d "Fonts" ]; then \
        chmod -R 755 Fonts && \
        echo "โ ูุฌูุฏ Fonts ููุฌูุฏ ูู /app/Fonts"; \
        ls -la Fonts/ | head -10; \
    else \
        echo "โ๏ธ ุชุญุฐูุฑ: ูุฌูุฏ Fonts ุบูุฑ ููุฌูุฏ!"; \
    fi

# ูุณุฎ ุฎุทูุท ุงูุชุทุจูู ุฅูู ูุฌูุฏุงุช Linux ุงููุธุงููุฉ
RUN if [ -d "Fonts" ]; then \
        echo "๐ฆ ูุณุฎ ุงูุฎุทูุท ุฅูู ูุฌูุฏุงุช Linux..."; \
        \
        # ูุณุฎ ุฅูู /usr/share/fonts/truetype/app-fonts
        mkdir -p /usr/share/fonts/truetype/app-fonts && \
        cp Fonts/*.TTF /usr/share/fonts/truetype/app-fonts/ 2>/dev/null || true && \
        cp Fonts/*.ttf /usr/share/fonts/truetype/app-fonts/ 2>/dev/null || true && \
        echo "โ ุชู ุงููุณุฎ ุฅูู: /usr/share/fonts/truetype/app-fonts"; \
        \
        # ูุณุฎ ุฅูู /usr/local/share/fonts
        mkdir -p /usr/local/share/fonts && \
        cp Fonts/*.TTF /usr/local/share/fonts/ 2>/dev/null || true && \
        cp Fonts/*.ttf /usr/local/share/fonts/ 2>/dev/null || true && \
        echo "โ ุชู ุงููุณุฎ ุฅูู: /usr/local/share/fonts"; \
        \
        # ูุณุฎ ุฅูู /usr/share/fonts/truetype/msttcorefonts
        mkdir -p /usr/share/fonts/truetype/msttcorefonts && \
        cp Fonts/*.TTF /usr/share/fonts/truetype/msttcorefonts/ 2>/dev/null || true && \
        cp Fonts/*.ttf /usr/share/fonts/truetype/msttcorefonts/ 2>/dev/null || true && \
        echo "โ ุชู ุงููุณุฎ ุฅูู: /usr/share/fonts/truetype/msttcorefonts"; \
        \
        # ุนุฑุถ ุนุฏุฏ ุงูุฎุทูุท
        FONT_COUNT=$(ls Fonts/*.TTF Fonts/*.ttf 2>/dev/null | wc -l); \
        echo "๐ ุชู ูุณุฎ $FONT_COUNT ุฎุท ุฅูู 3 ูุฌูุฏุงุช"; \
    fi

# ูุณุฎ ุฎุทูุท Windows ุฅุฐุง ูุงูุช ููุฌูุฏุฉ (ุงุฎุชูุงุฑู)
RUN if [ -d "windows-fonts" ]; then \
        mkdir -p /usr/share/fonts/truetype/msfonts && \
        mkdir -p /usr/local/share/fonts && \
        cp windows-fonts/*.ttf /usr/share/fonts/truetype/msfonts/ 2>/dev/null || true && \
        cp windows-fonts/*.TTF /usr/share/fonts/truetype/msfonts/ 2>/dev/null || true && \
        cp windows-fonts/*.ttf /usr/local/share/fonts/ 2>/dev/null || true && \
        cp windows-fonts/*.TTF /usr/local/share/fonts/ 2>/dev/null || true && \
        echo "โ ุชู ูุณุฎ ุฎุทูุท Windows ูู ูุฌูุฏ windows-fonts"; \
    fi

# ุชุนููู ุงูุตูุงุญูุงุช ุงูุตุญูุญุฉ ููุฌูุฏุงุช ุงูุฎุทูุท
RUN chmod -R 755 /usr/share/fonts/truetype/app-fonts 2>/dev/null || true && \
    chmod -R 755 /usr/share/fonts/truetype/msttcorefonts 2>/dev/null || true && \
    chmod -R 755 /usr/local/share/fonts 2>/dev/null || true && \
    echo "โ ุชู ุชุนููู ุงูุตูุงุญูุงุช"

# ุชุญุฏูุซ ูุงุด ุงูุฎุทูุท ูู ุฌููุน ุงููุฌูุฏุงุช (ููู ุฌุฏุงู ูู Skia)
RUN fc-cache -f -v && \
    echo "โ ุชู ุชุญุฏูุซ ูุงุด ุงูุฎุทูุท"

# ุงูุชุญูู ูู ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ ูู Skia
RUN echo "๐ ุงูุชุญูู ูู Native Libraries..." && \
    ldconfig -p | grep fontconfig && echo "โ libfontconfig ููุฌูุฏุฉ" || echo "โ libfontconfig ููููุฏุฉ" && \
    ldconfig -p | grep freetype && echo "โ libfreetype ููุฌูุฏุฉ" || echo "โ libfreetype ููููุฏุฉ" && \
    fc-list | grep -i arial && echo "โ ุฎุทูุท Arial ูุชุงุญุฉ" || echo "โ๏ธ ุฎุทูุท Arial ุบูุฑ ูุชุงุญุฉ" && \
    fc-list | grep -i liberation && echo "โ ุฎุทูุท Liberation ูุชุงุญุฉ" || echo "โ๏ธ ุฎุทูุท Liberation ุบูุฑ ูุชุงุญุฉ"

# ุฅูุดุงุก ูุฌูุฏ uploads ุฅุฐุง ูู ููู ููุฌูุฏุงู
RUN mkdir -p /app/wwwroot/uploads && chmod -R 777 /app/wwwroot/uploads

# ุชุนููู ุตูุงุญูุงุช ุงูุชูููุฐ ููููู ุงูุฑุฆูุณู
RUN chmod +x /app/medicalservices_api

# ุชุนููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
ENV ASPNETCORE_URLS=http://+:80
ENV ASPNETCORE_ENVIRONMENT=Production

# ููุทุฉ ุงูุฏุฎูู
ENTRYPOINT ["./medicalservices_api"]

